import{Storage as t}from"@google-cloud/storage";import{basename as e}from"path";import{writeFileSync as o}from"fs";import{file as r}from"tmp-promise";var a=function(t,e){this.config=t,this.providedPlatforms=e},n={platforms:{configurable:!0},name:{configurable:!0}};n.platforms.get=function(){return this.providedPlatforms||["win32","linux","darwin","mas"]},n.name.get=function(){return"googleStorage"},a.prototype.publish=function(a){var n=a.makeResults;try{for(var i=this.config,p=[],c=function(){var t=l[u];p.push.apply(p,t.artifacts.map(function(e){return{path:e,platform:t.platform,arch:t.arch}}))},u=0,l=n;u<l.length;u+=1)c();var s=new t({projectId:i?i.projectId:void 0});if(!i||!i.bucket)throw'In order to publish to Google Cloud Storage you must set the "googleCloudStorage.bucket" property in your forge config. See the docs for more info';var m=s.bucket(i.bucket),f=n[0].packageJSON.version;return Promise.resolve(Promise.all(p.map(function(t){try{var a=t.platform+"/"+e(t.path);return Promise.resolve(m.upload(t.path,{gzip:!0,destination:a,resumable:!1,metadata:{"cache-control":"public, max-age=31536000"},public:i.public})).then(function(){var e=JSON.stringify({version:f,url:(i.storageUrl||"https://storage.googleapis.com/"+m.name)+"/"+a,publishedAt:(new Date).toISOString()});return Promise.resolve(r()).then(function(r){return o(r.path,e),Promise.resolve(m.upload(r.path,{gzip:!0,destination:t.platform+"/manifest.json",contentType:"application/json",resumable:!1,metadata:{"cache-control":"public, max-age=60"},public:i.public})).then(function(){r.cleanup()})})})}catch(t){return Promise.reject(t)}}))).then(function(){})}catch(t){return Promise.reject(t)}},Object.defineProperties(a.prototype,n);export default a;
//# sourceMappingURL=PublisherGoogleStorage.mjs.map
